name: C++ / Python CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.12]

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 3️⃣ Install Python dependencies (PyTorch CPU-only)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pybind11 numpy pybind11-stubgen graphviz torch

      # 4️⃣ Install CMake and build tools
      - name: Install CMake and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ make pybind11-dev graphviz

      # 5️⃣ Configure and build C++ pybind11 module
      - name: Configure and build C++ module
        run: |
          mkdir -p core/build
          cd core/build
          cmake ..
          cmake --build . --config Release

      # 6️⃣ Generate pybind11 stubs
      - name: Generate pybind11 stubs
        run: |
          bash generate_stubs.sh

      # 7️⃣ Run Python tests
      - name: Run Python tests
        run: |
          python test/test.py
